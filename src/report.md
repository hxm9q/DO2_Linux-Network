## Part 1. Инструмент ipcalc
**== Выполнение ==**

### 1.1. Сети и маски

#### Определи и запиши в отчет:
1) Адрес сети 192.167.38.54/13
![part1.1](images/part1.1.1.png)
2) Перевод маски 255.255.255.0 в префиксную и двоичную запись, /15 в обычную и двоичную, 11111111.11111111.11111111.11110000 в обычную и префиксную
   
    В красном квадрате префиксная запись, двоичная справа
![part1.1](images/part1.1.2.png)
`ipcalc /15`
![part1.1](images/part1.1.3.png)

    У числа 11111111.11111111.11111111.11110000 префиксная запись /28
![part1.1](images/part1.1.4.png)
3) Минимальный и максимальный хост в сети 12.167.38.4 при масках: /8, 11111111.11111111.00000000.00000000, 255.255.254.0 и /4
![part1.1](images/part1.1.5.png)

### 1.2. localhost

#### Определи и запиши в отчёт, можно ли обратиться к приложению, работающему на localhost, со следующими IP: 194.34.23.100, 127.0.0.2, 127.1.0.1, 128.0.0.1

Для определения доступности приложения, работающего на `localhost` нужно учитывать, что `localhost` обычно сопоставляется с сетевым интерфейсом `loopback`, который находится в диапазоне IP-адресов 127.0.0.0/8
1) 194.34.23.100: IP-адрес не принадлежит необходимому диапазону, поэтому обратиться к нему нельзя
2) 127.0.0.2: IP-адрес принадлежит диапазону, обратиться можно
3) 127.1.0.1: IP-адрес принадлежит диапазону, обратиться можно
4) 128.0.0.1: IP-адрес не принадлежит необходимому диапазону, поэтому обратиться к нему нельзя

### 1.3. Диапазоны и сегменты сетей

#### Определи и запиши в отчёт:

1) Какие из перечисленных IP можно использовать в качестве публичного, а какие только в качестве частных: 10.0.0.45, 134.43.0.2, 192.168.4.2, 172.20.250.4, 172.0.2.1, 192.172.0.1, 172.68.0.2, 172.16.255.255, 10.10.10.10, 192.169.168.1
  

   Для определения, можно ли использовать перечисленные IP-адреса в качестве публичных или частных, мы должны применить стандарты и соглашения, определенные в спецификации IP-адресации.

   К частным IP адресам относятся диапазоны:
   
   - 10.0.0.0 — 10.255.255.255
   - 100.64.0.0 — 100.127.255.255
   - 172.16.0.0 — 172.31.255.255
   - 192.168.0.0 — 192.168.255.255
 
   Публичные адреса:
   - 134.43.0.2
   - 172.0.2.1
   - 192.172.0.1
   - 172.68.0.2
   - 192.169.168.1

   Частные адреса:
   - 10.0.0.45
   - 192.168.4.2
   - 172.20.250.4
   - 172.16.255.255
   - 10.10.10.10

2) Какие из перечисленных IP адресов шлюза возможны у сети 10.10.0.0/18: 10.0.0.1, 10.10.0.2, 10.10.10.10, 10.10.100.1, 10.10.1.255

   Для определения возможных IP-адресов шлюза в сети 10.10.0.0/18 мы должны учитывать следующие факты:

   * Шлюз (или шлюз по умолчанию) - это узел в сети TCP/IP, который используется для маршрутизации трафика из одной сети в другую. Шлюз обычно является первым узлом в сети, через который проходит трафик к внешним сетям.

   * Адрес шлюза должен находиться в той же подсети, что и устройства в этой сети.
   
   Найдем диапазон возможных адресов:
![part1.3](images/part1.3.1.png)

   Таким образом, возможными IP-адресами шлюза для сети 10.10.0.0/18 являются 10.10.0.2 и 10.10.10.10
## Part 2. Статическая маршрутизация между двумя машинами
**== Выполнение ==**

#### Подними две виртуальные машины
#### С помощью команды ip a посмотри существующие сетевые интерфейсы.

![part2](images/part2.1.png)
![part2](images/part2.2.png)

#### Опиши сетевой интерфейс, соответствующий внутренней сети, на обеих машинах и задать следующие адреса и маски: ws1 - 192.168.100.10, маска /16, ws2 - 172.24.116.8, маска /12.

![part2](images/part2.3.png)
![part2](images/part2.4.png)

#### Выполни команду `netplan apply` для перезапуска сервиса сети.

![part2](images/part2.5.png)
![part2](images/part2.6.png)

### 2.1. Добавление статического маршрута вручную

#### Добавь статический маршрут от одной машины до другой и обратно при помощи команды вида `ip r add`.
#### Пропингуй соединение между машинами.

![part2](images/part2.1.1.png)
![part2](images/part2.1.2.png)

### 2.2. Добавление статического маршрута с сохранением

#### Перезапусти машины.
#### Добавь статический маршрут от одной машины до другой с помощью файла etc/netplan/00-installer-config.yaml.

![part2](images/part2.2.1.png)
![part2](images/part2.2.2.png)

#### Пропингуй соединение между машинами.

![part2](images/part2.2.3.png)
![part2](images/part2.2.4.png)
## Part 3. Утилита iperf3
**== Выполнение ==**

### 3.1 Скорость соединения

#### Переведи и запиши в отчёт: 8 Mbps в MB/s, 100 MB/s в Kbps, 1 Gbps в Mbps.
```
8 Mbps = 1 MB/s
100 MB/s = 800000 Kbps
1 Gbps = 1000 Mbps
```
### 3.2. Утилита iperf3

#### Измерь скорость соединения между ws1 и ws2.

![part3](images/part3.1.png)
![part3](images/part3.2.png)
## Part 4. Сетевой экран
**== Выполнение ==**

### 4.1. Утилита iptables

#### Создай файл `/etc/firewall.sh`, имитирующий фаерволл, на ws1 и ws2:

![part4](images/part4.1.1.png)
![part4](images/part4.1.2.png)

#### Запусти файлы на обеих машинах командами `chmod +x /etc/firewall.sh` и `/etc/firewall.sh`.

![part4](images/part4.1.3.png)
![part4](images/part4.1.4.png)

### 4.2. Утилита nmap

#### Командой `ping` найди машину, которая не «пингуется»

![part4](images/part4.2.1.png)
![part4](images/part4.2.2.png)

#### после чего утилитой `nmap` покажи, что хост машины запущен.

![part4](images/part4.2.3.png)
## Part 5. Статическая маршрутизация сети
**== Выполнение ==**

#### Подними пять виртуальных машин (3 рабочие станции (ws11, ws21, ws22) и 2 роутера (r1, r2)).

### 5.1. Настройка адресов машин

#### Настрой конфигурации машин в `etc/netplan/00-installer-config.yaml` согласно сети на рисунке.

![part5](images/part5.1.png)
![part5](images/part5.2.png)
![part5](images/part5.3.png)
![part5](images/part5.4.png)
![part5](images/part5.5.png)

#### Перезапусти сервис сети. Если ошибок нет, то командой `ip -4 a` проверь, что адрес машины задан верно. Также пропингуй ws22 с ws21. Аналогично пропингуй r1 с ws11.

![part5](images/part5.6.png)
![part5](images/part5.7.png)

### 5.2. Включение переадресации IP-адресов

#### Для включения переадресации IP, выполни команду на роутерах:
#### `sysctl -w net.ipv4.ip_forward=1`
#### При таком подходе переадресация не будет работать после перезагрузки системы.

![part5](images/part5.2.1.png)
![part5](images/part5.2.2.png)

#### Открой файл `/etc/sysctl.conf` и добавь в него следующую строку:

![part5](images/part5.2.3.png)
![part5](images/part5.2.4.png)

### 5.3. Установка маршрута по-умолчанию

#### Настрой маршрут по-умолчанию (шлюз) для рабочих станций. Для этого добавь default перед IP роутера в файле конфигураций.

![part5](images/part5.3.1.png)
![part5](images/part5.3.2.png)
![part5](images/part5.3.3.png)

#### Вызови `ip r` и покажи, что добавился маршрут в таблицу маршрутизации.

![part5](images/part5.3.4.png)
![part5](images/part5.3.5.png)
![part5](images/part5.3.6.png)

#### Пропингуй с ws11 роутер r2 и покажи на r2, что пинг доходит. Для этого используй команду: `tcpdump -tn -i eth0`

![part5](images/part5.3.7.png)

### 5.4. Добавление статических маршрутов

#### Добавь в роутеры r1 и r2 статические маршруты в файле конфигураций.

![part5](images/part5.4.png)
![part5](images/part5.5.png)

#### Вызови `ip r` и покажи таблицы с маршрутами на обоих роутерах.

![part5](images/part5.4.1.png)
![part5](images/part5.4.2.png)
![part5](images/part5.4.3.png)

#### Для адреса 10.10.0.0/18 был выбран маршрут, отличный от 0.0.0.0/0, т.к. при наличии нескольких маршрутов одинаковой длины выбирается наиболее точно заданный.

### 5.5. Построение списка маршрутизаторов

#### Запусти на r1 команду дампа: `tcpdump -tnv -i eth0`

#### При помощи утилиты traceroute построй список маршрутизаторов на пути от ws11 до ws21.

![part5](images/part5.5.1.png)
![part5](images/part5.5.2.png)

#### Traceroute отправляет пакеты с изменяющимся TTL к целевому хосту. Каждый промежуточный маршрутизатор на пути отвечает ICMP сообщением о времени истечения TTL, позволяя определить IP-адрес и время прохождения каждого узла.

### 5.6. Использование протокола ICMP при маршрутизации

#### Запусти на r1 перехват сетевого трафика, проходящего через eth0 с помощью команды: `tcpdump -n -i eth0 icmp`

![part5](images/part5.6.1.png)

#### Пропингуй с ws11 несуществующий IP (например, 10.30.0.111)

![part5](images/part5.6.2.png)

## Part 6. Динамическая настройка IP с помощью DHCP
**== Выполнение ==**

#### Для r2 настрой в файле /etc/dhcp/dhcpd.conf конфигурацию службы DHCP:

![part6](images/part6.1.png)

#### В файле resolv.conf пропиши `nameserver 8.8.8.8`.

![part6](images/part6.2.png)

#### Перезагрузи службу DHCP командой systemctl restart isc-dhcp-server. Машину ws21 перезагрузи при помощи reboot и через ip a покажи, что она получила адрес. Также пропингуй ws22 с ws21.

![part6](images/part6.3.png)
![part6](images/part6.4.png)

#### Укажи MAC адрес у ws11, для этого в etc/netplan/00-installer-config.yaml надо добавить строки: `macaddress: 10:10:10:10:10:BA`, `dhcp4: true`.

![part6](images/part6.5.png)

#### Для r1 настрой аналогично r2, но сделай выдачу адресов с жесткой привязкой к MAC-адресу (ws11). Проведи аналогичные тесты.

#### Изменю конфигурацию файла /etc/dhcp/dhcpd.conf
![part6](images/part6.6.png)
#### Изменю конфигурацию файла /etc/resolv.conf
![part6](images/part6.7.png)
#### Перезагружу службу DHCP
![part6](images/part6.8.png)
#### `ip a` на ws11
![part6](images/part6.9.png)

#### Запроси с ws21 обновление ip адреса.

![part6](images/part6.10.png)

## Part 7. NAT
**== Выполнение ==**

#### В файле /etc/apache2/ports.conf на ws22 и r1 измени строку Listen 80 на Listen 0.0.0.0:80, то есть сделай сервер Apache2 общедоступным.

![part7](images/part7.1.png)
![part7](images/part7.2.png)

#### Добавь в фаервол, созданный по аналогии с фаерволом из Части 4, на r2 следующие правила:

1) Удаление правил в таблице filter - `iptables -F`;

2) Удаление правил в таблице "NAT" - `iptables -F -t nat`;

3) Отбрасывать все маршрутизируемые пакеты - `iptables --policy FORWARD DROP`.

4) Разрешить маршрутизацию всех пакетов протокола ICMP.

![part7](images/part7.3.png)

#### Проверь соединение между ws22 и r1 командой `ping`.

![part7](images/part7.4.png)

#### Добавь в файл ещё два правила:

5) Включи SNAT, а именно маскирование всех локальных ip из локальной сети, находящейся за r2 (по обозначениям из Части 5 - сеть 10.20.0.0).

6) Включи DNAT на 8080 порт машины r2 и добавить к веб-серверу Apache, запущенному на ws22, доступ извне сети.

![part7](images/part7.5.png)

#### Проверь соединение по TCP для DNAT: для этого с r1 подключиться к серверу Apache на ws22 командой `telnet` (обращаться по адресу r2 и порту 8080).

![part7](images/part7.6.png)

## Part 8. Дополнительно. Знакомство с SSH Tunnels
**== Выполнение ==**

#### Запусти на r2 фаервол с правилами из Части 7.
#### Запусти веб-сервер Apache на ws22 только на localhost (то есть в файле /etc/apache2/ports.conf измени строку `Listen 80` на `Listen localhost:80`).

![part8](images/part8.1.png)

#### Воспользуйся Local TCP forwarding с ws21 до ws22, чтобы получить доступ к веб-серверу на ws22 с ws21.
#### Воспользуйся Remote TCP forwarding c ws11 до ws22, чтобы получить доступ к веб-серверу на ws22 с ws11.
#### Для проверки, сработало ли подключение в обоих предыдущих пунктах, перейди во второй терминал (например, клавишами Alt + F2) и выполни команду: `telnet 127.0.0.1 [локальный порт]`

![part8](images/part8.2.png)